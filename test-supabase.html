<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase Connection Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .test-result {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid;
      }
      .success {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border-color: #17a2b8;
        color: #0c5460;
      }
      .loading {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border: 2px solid #e9ecef;
      }
      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        color: #6c757d;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Supabase Connection Test</h1>
      <p>
        Test your Supabase database connection and operations for the Bangkok
        Air Quality Dashboard.
      </p>

      <div class="button-group">
        <button onclick="testConnection()">üîó Test Connection</button>
        <button onclick="testInsert()">üìù Test Insert</button>
        <button onclick="testQuery()">üîç Test Query</button>
        <button onclick="getStats()">üìä Get Stats</button>
        <button onclick="clearResults()">üßπ Clear</button>
      </div>

      <div id="results"></div>
    </div>

    <script type="module">
      // Your actual Supabase credentials
      const SUPABASE_URL = "https://plrjbynejtbuawxijejf.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBscmpieW5lanRidWF3eGlqZWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MTU1MjksImV4cCI6MjA3Mjk5MTUyOX0.BuoYEm1oloP6Fvt87fZagOqRAwPw8B5kf9cUh13uuQk";

      // Import Supabase (using CDN for testing)
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      // Check if credentials are configured
      if (
        SUPABASE_URL === "https://your-project-id.supabase.co" ||
        SUPABASE_ANON_KEY === "your_supabase_anon_key_here"
      ) {
        addResult(
          "error",
          "‚ùå Please update the Supabase credentials in this test file first!",
        );
      }

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function addResult(type, message, data = null) {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `test-result ${type}`;

        let content = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
        if (data) {
          content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        div.innerHTML = content;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
      }

      window.testConnection = async function () {
        addResult("loading", "üîç Testing Supabase connection...");

        try {
          const { data, error } = await supabase
            .from("stations")
            .select("count")
            .limit(1);

          if (error) throw error;

          addResult("success", "‚úÖ Supabase connection successful!");

          // Test database functions
          const { data: aqhiTest } = await supabase.rpc("calculate_aqhi", {
            pm25_val: 50,
            no2_val: 30,
            o3_val: 40,
            so2_val: 20,
          });

          addResult("success", `üßÆ AQHI calculation test: ${aqhiTest}`, {
            input: { pm25: 50, no2: 30, o3: 40, so2: 20 },
            aqhi: aqhiTest,
          });
        } catch (error) {
          addResult("error", "‚ùå Connection failed", error);
        }
      };

      window.testInsert = async function () {
        addResult("loading", "üìù Testing data insertion...");

        const testReading = {
          station_uid: 9999,
          timestamp: new Date().toISOString(),
          lat: 13.7563,
          lon: 100.5018,
          aqi: 85,
          pm25: 75.5,
          no2: 45.2,
          o3: 35.8,
          so2: 25.1,
          pm10: 90.3,
          co: 1.2,
          station_name: "Test Station Bangkok",
        };

        try {
          const { data, error } = await supabase
            .from("air_quality_readings")
            .insert([testReading])
            .select();

          if (error) throw error;

          addResult("success", "‚úÖ Test data inserted successfully!", data);

          // Clean up test data
          await supabase
            .from("air_quality_readings")
            .delete()
            .eq("station_uid", 9999);

          addResult("info", "üßπ Test data cleaned up");
        } catch (error) {
          addResult("error", "‚ùå Insert failed", error);
        }
      };

      window.testQuery = async function () {
        addResult("loading", "üîç Testing data queries...");

        try {
          // Test stations query
          const { data: stations, error: stationsError } = await supabase
            .from("stations")
            .select("*")
            .limit(5);

          if (stationsError) throw stationsError;

          addResult(
            "success",
            `üìç Found ${stations.length} stations`,
            stations,
          );

          // Test current 3-hour averages view
          const { data: averages, error: avgError } = await supabase
            .from("current_3h_averages")
            .select("*")
            .limit(3);

          if (avgError && avgError.code !== "PGRST116") {
            // Ignore "no rows" error
            throw avgError;
          }

          addResult(
            "success",
            `üìä Found ${averages?.length || 0} stations with 3-hour averages`,
            averages,
          );
        } catch (error) {
          addResult("error", "‚ùå Query failed", error);
        }
      };

      window.getStats = async function () {
        addResult("loading", "üìä Getting database statistics...");

        try {
          // Get table counts
          const { count: readingsCount } = await supabase
            .from("air_quality_readings")
            .select("*", { count: "exact", head: true });

          const { count: stationsCount } = await supabase
            .from("stations")
            .select("*", { count: "exact", head: true });

          const { count: activeStationsCount } = await supabase
            .from("stations")
            .select("*", { count: "exact", head: true })
            .eq("is_active", true);

          const stats = {
            totalReadings: readingsCount || 0,
            totalStations: stationsCount || 0,
            activeStations: activeStationsCount || 0,
            lastUpdated: new Date().toISOString(),
          };

          // Display stats in a nice format
          const statsHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalReadings}</div>
                            <div class="stat-label">Total Readings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.totalStations}</div>
                            <div class="stat-label">Total Stations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.activeStations}</div>
                            <div class="stat-label">Active Stations</div>
                        </div>
                    </div>
                `;

          const div = document.createElement("div");
          div.className = "test-result success";
          div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: üìä Database Statistics${statsHTML}`;
          document.getElementById("results").appendChild(div);
        } catch (error) {
          addResult("error", "‚ùå Failed to get stats", error);
        }
      };

      window.clearResults = function () {
        document.getElementById("results").innerHTML = "";
      };

      // Initial connection test
      setTimeout(() => {
        if (SUPABASE_URL !== "https://your-project-id.supabase.co") {
          testConnection();
        }
      }, 1000);
    </script>
  </body>
</html>
