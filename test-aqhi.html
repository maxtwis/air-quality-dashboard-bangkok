<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AQHI Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .success {
            color: #10b981;
        }
        .error {
            color: #ef4444;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>AQHI Calculation Tests</h1>
        <div id="test-results"></div>
    </div>

    <script type="module">
        import { calculateAQHI, getAQHILevel, formatAQHI, calculateStationAQHI } from './js/aqhi.js';

        const testCases = [
            {
                name: "Test Case 1: All pollutants present",
                pm25: 35,
                no2: 40,
                o3: 60,
                so2: 25,
                description: "Typical urban conditions with moderate pollution"
            },
            {
                name: "Test Case 2: High PM2.5",
                pm25: 100,
                no2: 30,
                o3: 50,
                so2: 20,
                description: "High particulate matter pollution"
            },
            {
                name: "Test Case 3: Only PM2.5 (others missing)",
                pm25: 50,
                no2: 0,
                o3: 0,
                so2: 0,
                description: "Station with only PM2.5 sensor"
            },
            {
                name: "Test Case 4: Very high pollution",
                pm25: 200,
                no2: 80,
                o3: 100,
                so2: 60,
                description: "Severe pollution event with all pollutants high"
            },
            {
                name: "Test Case 5: Clean air",
                pm25: 10,
                no2: 15,
                o3: 30,
                so2: 10,
                description: "Good air quality conditions"
            },
            {
                name: "Test Case 6: Industrial pollution (high SO2)",
                pm25: 40,
                no2: 35,
                o3: 45,
                so2: 80,
                description: "Industrial area with elevated SO2"
            },
            {
                name: "Test Case 7: Missing PM2.5",
                pm25: 0,
                no2: 45,
                o3: 55,
                so2: 20,
                description: "Station without PM2.5 sensor"
            }
        ];

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let html = '';

            // Test individual calculations
            html += '<h2>Individual AQHI Calculations (with SO2)</h2>';
            html += '<table>';
            html += '<tr><th>Test Case</th><th>PM2.5</th><th>NO2</th><th>O3</th><th>SO2</th><th>AQHI</th><th>Level</th><th>Color</th></tr>';

            testCases.forEach(testCase => {
                const aqhi = calculateAQHI(testCase.pm25, testCase.no2, testCase.o3, testCase.so2);
                const level = getAQHILevel(aqhi);
                const formatted = formatAQHI(aqhi);

                html += `<tr>
                    <td>${testCase.name}</td>
                    <td>${testCase.pm25} μg/m³</td>
                    <td>${testCase.no2} μg/m³</td>
                    <td>${testCase.o3} μg/m³</td>
                    <td>${testCase.so2} μg/m³</td>
                    <td><strong>${formatted}</strong></td>
                    <td>${level.label}</td>
                    <td><span style="display: inline-block; width: 20px; height: 20px; background: ${level.color}; border-radius: 4px; vertical-align: middle;"></span></td>
                </tr>`;
            });

            html += '</table>';

            // Test with station data format
            html += '<h2>Station Data Format Test</h2>';
            const mockStation = {
                uid: 5773,
                aqi: "85",
                lat: 13.7563,
                lon: 100.5018,
                iaqi: {
                    pm25: { v: 75 },
                    no2: { v: 45 },
                    o3: { v: 35 },
                    so2: { v: 25 }
                },
                station: {
                    name: "Test Station Bangkok"
                }
            };

            const stationAQHI = calculateStationAQHI(mockStation);
            html += `<div class="test-case">
                <h3>Mock Station: ${mockStation.station.name}</h3>
                <p>AQI: ${mockStation.aqi}</p>
                <p>Pollutants: PM2.5: ${mockStation.iaqi.pm25.v}, NO2: ${mockStation.iaqi.no2.v}, O3: ${mockStation.iaqi.o3.v}, SO2: ${mockStation.iaqi.so2.v}</p>
                <div class="result">
                    <p><strong>AQHI: ${formatAQHI(stationAQHI.value)}</strong></p>
                    <p>Level: ${stationAQHI.level.label}</p>
                    <p>Description: ${stationAQHI.level.description}</p>
                    <p>Has All Data: ${stationAQHI.hasAllData ? 'Yes' : 'No'}</p>
                    ${stationAQHI.missingPollutants.length > 0 ? `<p>Missing: ${stationAQHI.missingPollutants.join(', ')}</p>` : ''}
                </div>
            </div>`;

            // Test edge cases
            html += '<h2>Edge Cases</h2>';
            const edgeCases = [
                { pm25: -10, no2: 20, o3: 30, name: "Negative PM2.5" },
                { pm25: null, no2: 20, o3: 30, name: "Null PM2.5" },
                { pm25: undefined, no2: 20, o3: 30, name: "Undefined PM2.5" },
                { pm25: 0, no2: 0, o3: 0, name: "All zeros" },
                { pm25: 500, no2: 200, o3: 300, name: "Extremely high values" }
            ];

            html += '<table>';
            html += '<tr><th>Edge Case</th><th>Input</th><th>AQHI Result</th><th>Status</th></tr>';

            edgeCases.forEach(edge => {
                try {
                    const aqhi = calculateAQHI(edge.pm25, edge.no2, edge.o3);
                    html += `<tr>
                        <td>${edge.name}</td>
                        <td>PM2.5: ${edge.pm25}, NO2: ${edge.no2}, O3: ${edge.o3}</td>
                        <td>${formatAQHI(aqhi)}</td>
                        <td class="success">✓ Passed</td>
                    </tr>`;
                } catch (error) {
                    html += `<tr>
                        <td>${edge.name}</td>
                        <td>PM2.5: ${edge.pm25}, NO2: ${edge.no2}, O3: ${edge.o3}</td>
                        <td>Error: ${error.message}</td>
                        <td class="error">✗ Failed</td>
                    </tr>`;
                }
            });

            html += '</table>';

            resultsDiv.innerHTML = html;
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>