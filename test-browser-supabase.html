<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Supabase Connection</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .log {
        background: #2a2a2a;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: monospace;
      }
      .success {
        color: #4ade80;
      }
      .error {
        color: #ef4444;
      }
      .warning {
        color: #fbbf24;
      }
      button {
        background: #3b82f6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #2563eb;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .status.loading {
        background: #374151;
      }
      .status.success {
        background: #065f46;
      }
      .status.error {
        background: #7f1d1d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”¥ Supabase Connection Test</h1>
      <div id="status" class="status loading">Initializing...</div>

      <div class="buttons">
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="testStorageService()">Test Storage Service</button>
        <button onclick="testAQHIService()">Test AQHI Service</button>
        <button onclick="clearLogs()">Clear Logs</button>
      </div>

      <div id="logs"></div>
    </div>

    <script type="module">
      import { AirQualityDB } from "./lib/supabase.js";
      import { airQualityStorage } from "./js/storage.js";
      import { supabaseAQHI } from "./js/aqhi-supabase.js";

      let logCount = 0;

      function log(message, type = "info") {
        logCount++;
        const logElement = document.createElement("div");
        logElement.className = `log ${type}`;
        logElement.innerHTML = `${logCount}. ${message}`;
        document.getElementById("logs").appendChild(logElement);
        console.log(message);
      }

      function setStatus(message, type = "loading") {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      // Make functions available globally
      window.testConnection = async function () {
        try {
          setStatus("Testing database connection...", "loading");
          log("ðŸ”„ Testing Supabase connection...");

          const result = await AirQualityDB.testConnection();
          if (result) {
            log("âœ… Database connection successful!", "success");
            setStatus("âœ… Connected to Supabase", "success");

            // Get stats
            const stats = await AirQualityDB.getDBStats();
            log(`ðŸ“Š Database stats: ${JSON.stringify(stats)}`, "success");
          } else {
            log("âŒ Database connection failed", "error");
            setStatus("âŒ Connection failed", "error");
          }
        } catch (error) {
          log(`âŒ Connection test failed: ${error.message}`, "error");
          setStatus("âŒ Connection error", "error");
        }
      };

      window.testStorageService = async function () {
        try {
          setStatus("Testing storage service...", "loading");
          log("ðŸ”„ Testing storage service initialization...");

          const isEnabled = airQualityStorage.isStorageEnabled();
          log(
            `ðŸ“¦ Storage service enabled: ${isEnabled}`,
            isEnabled ? "success" : "warning",
          );

          if (isEnabled) {
            const stats = await airQualityStorage.getStats();
            log(`ðŸ“Š Storage stats: ${JSON.stringify(stats)}`, "success");
            setStatus("âœ… Storage service working", "success");
          } else {
            setStatus("âš ï¸ Storage service disabled", "warning");
          }
        } catch (error) {
          log(`âŒ Storage test failed: ${error.message}`, "error");
          setStatus("âŒ Storage error", "error");
        }
      };

      window.testAQHIService = async function () {
        try {
          setStatus("Testing AQHI service...", "loading");
          log("ðŸ”„ Testing AQHI service...");

          // Create a test station
          const testStation = {
            uid: "test-123",
            aqi: 75,
            lat: 13.7563,
            lon: 100.5018,
            station: { name: "Test Station" },
            iaqi: {
              pm25: { v: 75 },
              pm10: { v: 85 },
              o3: { v: 65 },
              no2: { v: 45 },
            },
          };

          const aqhiResult = await supabaseAQHI.calculateAQHI(testStation);
          log(`ðŸ§® AQHI calculation: ${JSON.stringify(aqhiResult)}`, "success");

          const cacheStats = supabaseAQHI.getCacheStats();
          log(`ðŸ“Š AQHI cache stats: ${JSON.stringify(cacheStats)}`, "success");

          setStatus("âœ… AQHI service working", "success");
        } catch (error) {
          log(`âŒ AQHI test failed: ${error.message}`, "error");
          setStatus("âŒ AQHI error", "error");
        }
      };

      window.clearLogs = function () {
        document.getElementById("logs").innerHTML = "";
        logCount = 0;
        setStatus("Ready for testing", "loading");
      };

      // Initialize on load
      window.addEventListener("load", async () => {
        log("ðŸš€ Supabase test page loaded");
        log(
          "ðŸ”§ Available services: AirQualityDB, airQualityStorage, supabaseAQHI",
        );
        setStatus("Ready for testing", "loading");
      });
    </script>
  </body>
</html>
